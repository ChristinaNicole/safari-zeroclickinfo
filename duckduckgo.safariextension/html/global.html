<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8' />
    <title>DuckDuckGo</title>
    <script type="text/javascript">
    function ddgRightClickCommand(event) {
        var searchTerms = event.userInfo;
        var searchURL = "https://duckduckgo.com/?q=" + searchTerms;

        var tab = safari.application.activeBrowserWindow.openTab();
        tab.url = searchURL;
        tab.activate();

    }

    function ddgRightClickValidate(event) {
      var selectedText = event.userInfo;

      if (event.command !== 'ddg_context' || selectedText === undefined) {
        return;
      }
      if (selectedText.length == 0 || !selectedText) {
        event.target.disabled = true;
      }

      var request = new XMLHttpRequest();  
      request.open('GET', 'https://api.duckduckgo.com?q=' + encodeURIComponent(selectedText) + '&format=json&d=1', false);
      request.send(null);  
        
      var out = [];
      if (request.status === 200) {  
          var res = JSON.parse(request.responseText);
       
          if (res['AnswerType'] !== "" || 
              (res['Type'] === 'A' && res['Abstract']  === '') || res['Type'] === 'E') {
              out[0] = res['Answer'];       
              out[1] = 'http://duckduckgo.com/icon16.png';
          } else if (res['Type'] === 'A' && res['Abstract'] !== '') {
              out[0] = res['Heading'] + ": " + res['AbstractText'];
              var source_base_url = res['AbstractURL'].match(/http.?:\/\/(.*?\.)?(.*\..*?)\/.*/)[2];
              out[1] = 'http://duckduckgo.com/i/' + source_base_url + '.ico';
          } else if (res['Type'] === 'D' && res['Definition'] !== '') { 
              out[0] = res['Definition'];                                  
              var source_base_url = res['AbstractURL'].match(/http.?:\/\/(.*?\.)?(.*\..*?)\/.*/)[2];
              out[1] = 'http://duckduckgo.com/i/' + source_base_url + '.ico';
       
          }  
      }  
 
      
      if (out[0])
        event.target.title = out[0];
      else
        event.target.title = 'Ask Dax about ' + selectedText ;
    }

    function ddgCheckMessage (event) {
      if (event.name === 'request_google') {
            if (safari.extension.settings.zeroclickinfo !== true) {
              event.target.page.dispatchMessage('response_google', '');
              return;
            }

            query = event.message;
            var req = new XMLHttpRequest();
            if (safari.extension.settings.meanings)
                req.open('GET', 'https://api.duckduckgo.com?q=' + encodeURIComponent(query) + '&format=json', true);
            else
                req.open('GET', 'https://api.duckduckgo.com?q=' + encodeURIComponent(query) + '&format=json&d=1', true);

            req.onreadystatechange = function(data) {
                if (req.readyState != 4)  { return; } 
                var res = JSON.parse(req.responseText);
                event.target.page.dispatchMessage('response_google', res);
            }
            req.send(null);
      }  
      if (event.name === 'request_bing') {
            if (safari.extension.settings.zeroclickinfo !== true) {
              event.target.page.dispatchMessage('response_bing', '');
              return;
            }

            query = event.message;
            var req = new XMLHttpRequest();
            if (safari.extension.settings.meanings)
                req.open('GET', 'https://api.duckduckgo.com?q=' + encodeURIComponent(query) + '&format=json', true);
            else
                req.open('GET', 'https://api.duckduckgo.com?q=' + encodeURIComponent(query) + '&format=json&d=1', true);

            req.onreadystatechange = function(data) {
                if (req.readyState != 4)  { return; } 
                var res = JSON.parse(req.responseText);
                event.target.page.dispatchMessage('response_bing', res);
            }
            req.send(null);
      }
      if (event.name === 'get_settings') {
        event.target.page.dispatchMessage('set_settings', safari.extension.settings);
      }
    }
    safari.application.addEventListener("validate", ddgRightClickValidate, false);
    safari.application.addEventListener("command", ddgRightClickCommand, false);
    safari.application.addEventListener("message", ddgCheckMessage, false);
    </script>
  </head>
</html>
